import React from "react";

const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Management (HTML + JS + Firebase)</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#4f46e5}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111}
    .app{max-width:1100px;margin:24px auto;display:grid;grid-template-columns:320px 1fr;gap:20px;padding:16px}
    .panel{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    h2{margin:0 0 12px 0}
    label{display:block;font-size:13px;color:#374151;margin-bottom:6px}
    input[type=text], input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;margin-bottom:10px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;border:1px solid #e6e9ef;display:flex;flex-direction:column}
    .cover{height:220px;background:#f3f4f6;display:flex;align-items:center;justify-content:center}
    .cover img{max-height:100%;max-width:100%;object-fit:contain}
    .meta{padding:12px}
    .meta h3{margin:0;font-size:16px}
    .meta p{margin:6px 0;color:#6b7280;font-size:13px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .notice{background:#fff7ed;border-left:4px solid #f59e0b;padding:10px;margin-bottom:12px;border-radius:6px;color:#92400e}
    @media (max-width:900px){.app{grid-template-columns:1fr;}.grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h2>Add / Seed Books</h2>
      <div id="configNotice" class="notice" style="display:none"></div>
      <form id="bookForm">
        <label>Title</label>
        <input id="title" type="text" required />
        <label>Author</label>
        <input id="author" type="text" required />
        <label>Price (INR)</label>
        <input id="price" type="number" step="0.01" />
        <label>Image URL</label>
        <input id="image" type="text" placeholder="https://..." />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addBtn" class="btn-primary" type="submit">Add Book</button>
          <button id="resetBtn" type="button" class="btn-ghost">Reset</button>
          <button id="seedBtn" type="button" class="btn-primary">Seed Dummy Data</button>
        </div>
      </form>
      <p style="margin-top:12px;color:#6b7280;font-size:13px">Notes: This page uses Firebase Firestore for realtime sync. Provide your Firebase config below in the <code>firebaseConfig</code> object inside the script.</p>
    </aside>

    <main class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h2>Books</h2>
        <div id="status">Loading...</div>
      </div>
      <div id="booksContainer" class="grid"></div>
      <div id="empty" style="display:none;text-align:center;padding:20px;color:#6b7280">No books yet. Add some from the sidebar.</div>
    </main>
  </div>

  <script type="module">
    // Import Firebase SDK (modular) from CDN
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    // ======= EDIT THIS: put your Firebase config here =======
    const firebaseConfig = {
      apiKey: "REPLACE_WITH_YOUR_API_KEY",
      authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
      projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
      storageBucket: "REPLACE_WITH_YOUR_STORAGE_BUCKET",
      messagingSenderId: "REPLACE_WITH_YOUR_MESSAGING_SENDER_ID",
      appId: "REPLACE_WITH_YOUR_APP_ID"
    };
    // =======================================================

    function isValidConfig(cfg){
      if(!cfg||typeof cfg!=='object') return false;
      if(!cfg.projectId) return false;
      for(const v of Object.values(cfg)){
        if(!v||typeof v!=='string') return false;
        if(v.startsWith('REPLACE_')) return false;
      }
      return true;
    }

    const DEFAULT_COVER = 'https://via.placeholder.com/200x280?text=No+Cover';

    const statusEl = document.getElementById('status');
    const booksContainer = document.getElementById('booksContainer');
    const emptyEl = document.getElementById('empty');
    const configNotice = document.getElementById('configNotice');

    let db=null;
    let booksCol=null;
    let unsubscribe = null;

    if(isValidConfig(firebaseConfig)){
      try{
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        booksCol = collection(db,'books');
      }catch(err){
        console.error('Init error',err);
        configNotice.style.display='block';
        configNotice.textContent = 'Firebase initialization failed: ' + (err.message||String(err));
      }
    } else {
      configNotice.style.display='block';
      configNotice.innerHTML = 'Firestore not initialized. Replace placeholders in <code>firebaseConfig</code> in the script with your Firebase project config and ensure Firestore is enabled.';
    }

    function renderBooks(list){
      booksContainer.innerHTML='';
      if(!list || list.length===0){
        emptyEl.style.display='block';
        statusEl.textContent = '0 books';
        return;
      }
      emptyEl.style.display='none';
      statusEl.textContent = list.length + ' books';
      list.forEach(b=>{
        const card = document.createElement('div'); card.className='card';
        const cover = document.createElement('div'); cover.className='cover';
        const img = document.createElement('img'); img.src = b.coverImageURL || DEFAULT_COVER;
        img.alt = b.title;
        img.onerror = ()=>{ img.src = DEFAULT_COVER };
        cover.appendChild(img);
        card.appendChild(cover);
        const meta = document.createElement('div'); meta.className='meta';
        const h3 = document.createElement('h3'); h3.textContent = b.title; meta.appendChild(h3);
        const p1 = document.createElement('p'); p1.textContent = 'by ' + b.author; meta.appendChild(p1);
        const p2 = document.createElement('p'); p2.textContent = '₹' + (Number(b.price)||0).toFixed(2); meta.appendChild(p2);
        const actions = document.createElement('div'); actions.className='actions';
        const upd = document.createElement('button'); upd.textContent='Update Author'; upd.className='btn-ghost';
        upd.onclick = async ()=>{
          const name = prompt('Enter new author name:', b.author);
          if(name===null) return; const trimmed = name.trim(); if(!trimmed) { alert('Author cannot be empty'); return; }
          try{
            if(db){
              await updateDoc(doc(db,'books',b.id),{author:trimmed});
            }
          }catch(err){console.error(err);alert('Failed to update: '+err.message)}
        };
        const del = document.createElement('button'); del.textContent='Delete'; del.className='btn-ghost';
        del.onclick = async ()=>{
          if(!confirm('Delete this book?')) return;
          try{
            if(db){ await deleteDoc(doc(db,'books',b.id)); }
          }catch(err){console.error(err);alert('Failed to delete: '+err.message)}
        };
        const view = document.createElement('button'); view.textContent='View Details'; view.className='btn-primary';
view.onclick = ()=>{
  alert('Title: '+b.title+'\nAuthor: '+b.author+'\nPrice: ₹'+(Number(b.price)||0).toFixed(2)+'\nID: '+b.id);
};
        actions.appendChild(upd); actions.appendChild(del); actions.appendChild(view);
        meta.appendChild(actions);
        card.appendChild(meta);
        booksContainer.appendChild(card);
      });
    }

    if(db && booksCol){
      const q = query(booksCol, orderBy('title'));
      unsubscribe = onSnapshot(q, snapshot=>{
        const arr = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
        renderBooks(arr);
      }, err=>{
        console.error('Listener error',err); statusEl.textContent='Error';
      });
    } else {
      // No Firestore: show empty state
      renderBooks([]);
    }

    // form handlers
    const form = document.getElementById('bookForm');
    const titleIn = document.getElementById('title');
    const authorIn = document.getElementById('author');
    const priceIn = document.getElementById('price');
    const imageIn = document.getElementById('image');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const seedBtn = document.getElementById('seedBtn');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        title: titleIn.value.trim(),
        author: authorIn.value.trim(),
        price: parseFloat(priceIn.value) || 0,
        coverImageURL: imageIn.value.trim() || DEFAULT_COVER,
        createdAt: new Date()
      };
      if(!payload.title || !payload.author){ alert('Title and Author required'); return; }
      if(!db){ alert('Firestore not initialized. Please configure firebaseConfig at top of the script.'); return; }
      try{
        await addDoc(booksCol,payload);
        titleIn.value=''; authorIn.value=''; priceIn.value=''; imageIn.value='';
      }catch(err){ console.error(err); alert('Add failed: '+(err.message||String(err))); }
    });

    resetBtn.addEventListener('click', ()=>{ titleIn.value=''; authorIn.value=''; priceIn.value=''; imageIn.value=''; });

    seedBtn.addEventListener('click', async ()=>{
      const dummy = [
        { title:'The Pragmatic Programmer', author:'Andrew Hunt', price:399, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/41as+WafrFL._SX376_BO1,204,203,200_.jpg' },
        { title:'Clean Code', author:'Robert C. Martin', price:449, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/41xShlnTZTL._SX374_BO1,204,203,200_.jpg' },
        { title:"You Don't Know JS", author:'Kyle Simpson', price:299, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/51i6X2n8bOL._SX331_BO1,204,203,200_.jpg' },
        { title:'Introduction to Algorithms', author:'Cormen, Leiserson, Rivest, Stein', price:999, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/41SNBw6aHML._SX379_BO1,204,203,200_.jpg' },
        { title:'Design Patterns', author:'Gamma, Helm, Johnson, Vlissides', price:549, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/51kuc0iWpOL._SX396_BO1,204,203,200_.jpg' },
        { title:'Eloquent JavaScript', author:'Marijn Haverbeke', price:249, coverImageURL:'https://images-na.ssl-images-amazon.com/images/I/51wZc2q0wNL._SX376_BO1,204,203,200_.jpg' }
      ];
      if(!db){ alert('Firestore not initialized. Please configure firebaseConfig at top of the script.'); return; }
      try{
        for(const b of dummy){ await addDoc(booksCol,{...b,createdAt:new Date()}); }
        alert('Seeded dummy books — check Firestore. (If you see duplicates, you may have seeded before)');
      }catch(err){ console.error(err); alert('Seed failed: '+(err.message||String(err))); }
    });

    // cleanup when page unloads
    window.addEventListener('beforeunload', ()=>{ if(unsubscribe) unsubscribe(); });

  </script>
</body>
</html>`;

export default function BookManagerIframe(){
  return (
    <iframe
      title="Book Manager (HTML+JS+Firebase)"
      srcDoc={html}
      style={{width:'100%',height:'100vh',border:'none'}}
      sandbox="allow-scripts allow-same-origin allow-forms"
    />
  );
}
